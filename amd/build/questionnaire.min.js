define(["jquery","core/templates","core/notification","core/ajax","core/str","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g){function h(b){a(".comment").each(function(){k[a(this).data("itemid")]=a(this).val().trim()});var d=a('[data-region="questionnaire"]'),f=d.data("touserid"),g=d.data("tousername"),h=d.data("threesixtyid"),l=d.data("anonymous");if(l&&b){var m=[{key:"finaliseanonymousfeedback",component:"mod_threesixty"},{key:"confirmfinaliseanonymousfeedback",component:"mod_threesixty",param:{name:g}}];e.get_strings(m,"mod_threesixty").done(function(a){j(a[0],a[1],h,f,k,b)}).fail(c.exception)}else i(h,f,k,b)}function i(a,b,f,g){var h=d.call([{methodname:"mod_threesixty_save_responses",args:{threesixtyid:a,touserid:b,responses:f,complete:g}}]);h[0].done(function(a){var b=[{key:"responsessaved",component:"mod_threesixty"},{key:"errorresponsesavefailed",component:"mod_threesixty"}];e.get_strings(b).done(function(b){var d={};a.result?(d.message=b[0],d.type="success"):(d.message=b[1],d.type="error"),c.addNotification(d)}).fail(c.exception),g&&(window.location=a.redirurl)}).fail(c.exception)}function j(b,c,d,h,j,k){var l=e.get_string("finalise","mod_threesixty"),m=f.create({title:b,body:c,large:!0,type:f.types.SAVE_CANCEL});a.when(l,m).done(function(a,b){b.setSaveButtonText(a),b.show(),b.getRoot().on(g.hidden,function(){b.setBody("")}),b.getRoot().on(g.save,function(){i(d,h,j,k)})})}var k=[],l=function(){this.registerEvents(),a('[data-region="question-row"]').each(function(){k[a(this).data("itemid")]=null});var b=a('[data-region="questionnaire"]'),c=b.data("fromuserid"),e=b.data("touserid"),f=b.data("threesixtyid"),g=d.call([{methodname:"mod_threesixty_get_responses",args:{threesixtyid:f,fromuserid:c,touserid:e}}]);g[0].done(function(b){a.each(b.responses,function(){var b=this;k[b.item]=b.value,a('[data-region="question-row"]').each(function(){if(a(this).data("itemid")==b.item){var c=a(this).children(".scaleoption");c&&c.each(function(){var c=a(this).find("label");c.data("value")==b.value&&(c.removeClass("label-default"),c.removeClass("label-info"),c.addClass("label-success"))});var d=a(this).find(".comment");if(d){var e=a(this).find("textarea");e.val(b.value)}}})})})};return l.prototype.registerEvents=function(){a(".scaleoption").click(function(b){b.preventDefault();var c=a(this).parent('[data-region="question-row"]'),d=c.find("label");a.each(d,function(){if(a(this).hasClass("label-success")){a(this).removeClass("label-success"),a(this).addClass("label-default");var b=a(this).attr("for"),c=a("#"+b);c.removeAttr("checked")}});var e=a(this).find("label");e.removeClass("label-default"),e.removeClass("label-info"),e.addClass("label-success");var f=a("#"+e.attr("for"));f.attr("checked","checked");var g=c.data("itemid");k[g]=e.data("value")}),a(".scaleoptionlabel").hover(function(b){b.preventDefault(),a(this).hasClass("label-success")||(a(this).hasClass("label-default")?(a(this).removeClass("label-default"),a(this).addClass("label-info")):(a(this).addClass("label-default"),a(this).removeClass("label-info")))}),a("#save-feedback").click(function(){h(!1)}),a("#submit-feedback").click(function(){h(!0)})},l});